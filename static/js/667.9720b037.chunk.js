(()=>{"use strict";var t={},e={};function a(n){var s=e[n];if(void 0!==s)return s.exports;var o=e[n]={exports:{}};return t[n](o,o.exports,a),o.exports}a.m=t,(()=>{var t,e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__;a.t=function(n,s){if(1&s&&(n=this(n)),8&s)return n;if("object"===typeof n&&n){if(4&s&&n.__esModule)return n;if(16&s&&"function"===typeof n.then)return n}var o=Object.create(null);a.r(o);var i={};t=t||[null,e({}),e([]),e(e)];for(var r=2&s&&n;("object"==typeof r||"function"==typeof r)&&!~t.indexOf(r);r=e(r))Object.getOwnPropertyNames(r).forEach(t=>i[t]=()=>n[t]);return i.default=()=>n,a.d(o,i),o}})(),a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.f={},a.e=t=>Promise.all(Object.keys(a.f).reduce((e,n)=>(a.f[n](t,e),e),[])),a.u=t=>"static/js/"+t+"."+{107:"ce040c18",851:"035746e7"}[t]+".chunk.js",a.miniCssF=t=>{},a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}(),a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.p="/mmr-strategy/",(()=>{var t={667:1};a.f.i=(e,n)=>{t[e]||importScripts(a.p+a.u(e))};var e=self.webpackChunkmmr_strategy_react=self.webpackChunkmmr_strategy_react||[],n=e.push.bind(e);e.push=e=>{var s=e[0],o=e[1],i=e[2];for(var r in o)a.o(o,r)&&(a.m[r]=o[r]);for(i&&i(a);s.length;)t[s.pop()]=1;n(e)}})();let n=function(t){return t.BigSpike="Big Spike",t.Spike="Spike",t.Excess="Excess",t.Shortfall="Shortfall",t.Drop="Drop",t.BigDrop="Big Drop",t}({});const s=(t,e,a)=>{const n=t.portfolioSnapshots[t.portfolioSnapshots.length-1],s=g(n),o=a.TQQQ[e]||0,i=a.QQQ[e]||0,r=n.investments.TQQQ*(o/100+1),l=n.investments.cash*(1+t.variables.cashDayRate),c=r+l,m={total:c,TQQQ:r,cash:l,ratio:r/(r+l),mockTotalQQQ:n.investments.mockTotalQQQ*(i/100+1),mockTotalTQQQ:n.investments.mockTotalTQQQ*(o/100+1)};return s.date=e,s.investments=m,s.peak=Math.max(n.peak,c),s.pullback=-(s.peak-c)/s.peak,s.cumulativeRateSinceRebalance=(1+s.cumulativeRateSinceRebalance)*(1+o/100)-1,s},o=(t,e,a)=>{const{monthlyNewCash:s,rebalanceDays:o,targetRatio:i,targetRate:r,dropRate:l}=e.variables;t.investments.cash+=s/30*o,t.investments.mockTotalQQQ+=s/30*o,t.investments.mockTotalTQQQ+=s/30*o,t.investments.total=t.investments.cash+t.investments.TQQQ,t.investments.ratio=t.investments.TQQQ/t.investments.total;const c=g(t),m=2*r,v=2*l,u=t.cumulativeRateSinceRebalance,p=u>=m,f=u<m&&u>=r,d=u<r&&t.investments.total>=t.nextTarget,h=t.investments.total<t.nextTarget&&u>=l,b=u<l&&u>=v,y=u<v;let R=n.Excess;if(p)R=n.BigSpike,c.investments.TQQQ=t.investments.total*Math.min(1.5*i,1),c.investments.cash=t.investments.total*(1-Math.min(1.5*i,1)),c.investments.total=t.investments.total,c.investments.ratio=c.investments.TQQQ/c.investments.total,c.nextTarget=t.investments.total*(1+1.5*r);else if(f)R=n.Spike,c.investments.TQQQ=t.investments.total*i*1,c.investments.cash=t.investments.total*(1-1*i),c.investments.total=t.investments.total,c.investments.ratio=c.investments.TQQQ/c.investments.total,c.nextTarget=t.investments.total*(1+1*r);else if(d){R=n.Excess;const e=t.investments.total-t.nextTarget,a=Math.min(e,t.investments.TQQQ);c.investments.TQQQ=t.investments.TQQQ-a,c.investments.cash=t.investments.cash+a,c.investments.total=t.investments.total,c.investments.ratio=c.investments.TQQQ/c.investments.total,c.nextTarget=t.nextTarget*(1+r)}else if(h){R=n.Shortfall;const e=t.nextTarget-t.investments.total,a=Math.min(e,t.investments.cash);c.investments.TQQQ=t.investments.TQQQ+a,c.investments.cash=t.investments.cash-a,c.investments.total=t.investments.total,c.investments.ratio=c.investments.TQQQ/c.investments.total,c.nextTarget=t.nextTarget*(1+r)}else b?R=n.Drop:y?(R=n.BigDrop,c.investments.TQQQ=t.investments.total*i*.75,c.investments.cash=t.investments.total*(1-.75*i),c.investments.total=t.investments.total,c.investments.ratio=c.investments.TQQQ/c.investments.total,c.nextTarget=t.investments.total*(1+.75*r)):console.log("bug");c.nextRebalanceDate=Q(t.date,o),c.cumulativeRateSinceRebalance=0;const S={date:t.date,before:t,after:c,cumulativeRateSinceLastRebalance:u,rebalanceType:R};return e.rebalanceLogs.push(S),c},i=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,r=t=>{if(!t||"string"!==typeof t)throw new Error(`Invalid date string: ${t}`);const e=t.split("-");if(3!==e.length)throw new Error(`Invalid date format. Expected YYYY-MM-DD, got: ${t}`);const[a,n,s]=e.map(Number);if(isNaN(a)||isNaN(n)||isNaN(s))throw new Error(`Invalid date components in: ${t}`);return new Date(a,n-1,s)},l=(t,e)=>{const a=r(t);return a.setDate(a.getDate()+e),i(a)},c=(t,e)=>{const a=r(t);return a.setFullYear(a.getFullYear()+e),i(a)},m=(t,e)=>{const i={...t,portfolioSnapshots:[],rebalanceLogs:[],variables:{...t.variables}};((t,e)=>{const a={total:t.variables.initialMoney,TQQQ:t.variables.initialMoney*t.variables.targetRatio,cash:t.variables.initialMoney*(1-t.variables.targetRatio),ratio:t.variables.targetRatio,mockTotalQQQ:t.variables.initialMoney,mockTotalTQQQ:t.variables.initialMoney},s=Object.keys(e.TQQQ).find(e=>e>=t.variables.startDate);if(!s)throw new Error(`No market data found for start date ${t.variables.startDate} or later`);t.variables.startDate=s;const o={date:s,investments:a,cumulativeRateSinceRebalance:0,nextTarget:t.variables.initialMoney*(1+t.variables.targetRate),peak:t.variables.initialMoney,pullback:0,lastRebalanceDate:s,nextRebalanceDate:l(s,t.variables.rebalanceDays)};t.portfolioSnapshots=[o];const i={date:s,before:o,after:o,cumulativeRateSinceLastRebalance:0,rebalanceType:n.Excess};t.rebalanceLogs=[i]})(i,e);const r=Object.entries(e.TQQQ);let c=0;for(const[n]of r){if(n<=i.variables.startDate)continue;if(n>i.variables.endDate)break;const t=s(i,n,e);if(n>=t.nextRebalanceDate){const e=o(t,i);i.portfolioSnapshots.push(e)}else i.portfolioSnapshots.push(t);c++,c%1e3===0&&a.g.gc&&a.g.gc()}if(i.portfolioSnapshots.length>0){const t=i.portfolioSnapshots[i.portfolioSnapshots.length-1];o(t,i),v(i)}return i},v=t=>{const e=t.portfolioSnapshots[t.portfolioSnapshots.length-1].date;t.annualizedStrategyRate=u(t.variables.initialMoney,t.portfolioSnapshots[t.portfolioSnapshots.length-1].investments.total,t.variables.startDate,e),t.annualizedQQQRate=u(t.variables.initialMoney,t.portfolioSnapshots[t.portfolioSnapshots.length-1].investments.mockTotalQQQ,t.variables.startDate,e),t.annualizedTQQQRate=u(t.variables.initialMoney,t.portfolioSnapshots[t.portfolioSnapshots.length-1].investments.mockTotalTQQQ,t.variables.startDate,e)},Q=l,g=t=>({...t,investments:{...t.investments}}),u=(t,e,a,n)=>{const s=((t,e)=>{const a=r(t);return(r(e).getTime()-a.getTime())/315576e5})(a,n);return s<=0?0:(e/t)**(1/s)-1},p=async(t,e,n,s,o)=>{var r,v;const Q=[],g=Object.keys(e.TQQQ).sort(),u=g[0],p=g[g.length-1],d=u>="2000-01-01"?u:"2000-01-01",h=i(new Date),b=c(p,-1),y=b<h?b:h,R=Math.ceil((new Date(y).getTime()-new Date(d).getTime())/864e5);let S=d,T=0,D=0,w=Date.now();const x=()=>{if("undefined"!==typeof performance&&performance.memory){const t=performance.memory;t.usedJSHeapSize>.9*t.jsHeapSizeLimit&&(console.warn("High memory usage detected, forcing garbage collection"),a.g.gc&&a.g.gc())}};for(;S<=y;){if(null!==o&&void 0!==o&&o.aborted){const t=new Error("Simulation cancelled");throw t.name="AbortError",t}const a=Date.now();a-w>5e3&&(x(),w=a);const i=S;D++;const r=g.find(t=>t>=i);if(r)try{const a=l(r,30);if(p>=a){const a=c(r,n),s={portfolioSnapshots:[],rebalanceLogs:[],variables:{...t,startDate:r,endDate:a}},o=m(s,e);o.portfolioSnapshots.length>0&&(Q.push({startDate:r,simulation:o}),T++)}}catch(k){if(k instanceof Error&&"AbortError"===k.name)throw k;console.warn(`Simulation failed for start date ${r}:`,k)}if(S=l(S,1),D%50===0){const t=Math.min(100,D/R*100);null===s||void 0===s||s(Math.round(t)),await new Promise(t=>requestAnimationFrame(()=>setTimeout(t,0)))}}console.log(`Completed ${T} simulations from ${null===(r=Q[0])||void 0===r?void 0:r.startDate} to ${null===(v=Q[Q.length-1])||void 0===v?void 0:v.startDate}`),null===s||void 0===s||s(100);const M=f(Q);return Q.length=0,{results:[],analysisResults:M}},f=t=>{var e,a;if(0===t.length)return{totalSimulations:0,averageStrategyRate:0,averageQQQRate:0,averageTQQQRate:0,bestStrategyRate:0,worstStrategyRate:0,winRate:0,resultsWithRates:[]};const n=t.map(t=>t.simulation.annualizedStrategyRate||0),s=t.map(t=>t.simulation.annualizedQQQRate||0),o=t.map(t=>t.simulation.annualizedTQQQRate||0),i=n.reduce((t,e)=>t+e,0)/n.length,r=s.reduce((t,e)=>t+e,0)/s.length,l=o.reduce((t,e)=>t+e,0)/o.length,c=Math.max(...n),m=Math.min(...n),v=100*(i/r-1),Q=t.filter(t=>(t.simulation.annualizedStrategyRate||0)>(t.simulation.annualizedQQQRate||0)).length/t.length*100,g=t.map(t=>({startDate:t.startDate,strategyRate:t.simulation.annualizedStrategyRate||0,qqqRate:t.simulation.annualizedQQQRate||0,tqqqRate:t.simulation.annualizedTQQQRate||0}));return console.log("Absolute worst 10"),g.sort((t,e)=>t.strategyRate-e.strategyRate).slice(0,10).forEach((t,e)=>{var a,n,s;console.log(`${e+1}. ${t.startDate}: Strategy= ${null===(a=100*t.strategyRate)||void 0===a?void 0:a.toFixed(2)}%, QQQ= ${null===(n=100*t.qqqRate)||void 0===n?void 0:n.toFixed(2)}%, TQQQ= ${null===(s=100*t.tqqqRate)||void 0===s?void 0:s.toFixed(2)}%`)}),console.log("Relative worst 10"),g.sort((t,e)=>t.strategyRate-t.qqqRate-(e.strategyRate-e.qqqRate)).slice(0,10).forEach((t,e)=>{var a,n,s;console.log(`${e+1}. ${t.startDate}: Strategy= ${null===(a=100*t.strategyRate)||void 0===a?void 0:a.toFixed(2)}%, QQQ= ${null===(n=100*t.qqqRate)||void 0===n?void 0:n.toFixed(2)}%, TQQQ= ${null===(s=100*t.tqqqRate)||void 0===s?void 0:s.toFixed(2)}%`)}),console.log("\naverageStrategyRate\t\t\t\t",`${(100*i).toFixed(2)}%`,"\nstrategyVsQQQImprovement\t\t\t\t",`${v.toFixed(2)}%`,"\nwinRateVsQQQ\t\t\t\t",`${Q.toFixed(2)}%`,"absoluteWorst",g.sort((t,e)=>t.strategyRate-e.strategyRate)[0].strategyRate.toFixed(2)+"%","relativeWorst",g.sort((t,e)=>t.strategyRate-t.qqqRate-(e.strategyRate-e.qqqRate))[0].strategyRate.toFixed(2)+"%"),{totalSimulations:t.length,averageStrategyRate:i,averageQQQRate:r,averageTQQQRate:l,bestStrategyRate:c,worstStrategyRate:m,dateRange:{start:null===(e=t[0])||void 0===e?void 0:e.startDate,end:null===(a=t[t.length-1])||void 0===a?void 0:a.startDate},resultsWithRates:g}};let d=null;self.addEventListener("message",async t=>{const{type:e,variables:a,marketData:n,nbYear:s}=t.data;if("CANCEL_SIMULATION"!==e){if("RUN_SIMULATIONS"===e&&a&&n&&s){d&&d.abort(),d=new AbortController;try{const t=t=>{self.postMessage({type:"SIMULATION_PROGRESS",progress:t})},e=await p(a,n,s,t,d.signal);d.signal.aborted||self.postMessage({type:"SIMULATION_COMPLETE",results:e})}catch(o){o instanceof Error&&"AbortError"===o.name?self.postMessage({type:"SIMULATION_CANCELLED"}):self.postMessage({type:"SIMULATION_ERROR",error:o instanceof Error?o.message:"Unknown error"})}finally{d=null}}}else d&&(d.abort(),d=null,self.postMessage({type:"SIMULATION_CANCELLED"}))})})();
//# sourceMappingURL=667.9720b037.chunk.js.map